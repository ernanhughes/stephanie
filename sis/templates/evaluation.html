{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
  <h1 class="mb-4">Evaluations for Pipeline Run {{ pipeline_run_id }}</h1>

  {% if evaluations %}
    <div class="accordion" id="evaluationAccordion">
      {% for eval in evaluations %}
      <div class="accordion-item">
        <h2 class="accordion-header" id="heading-{{ eval.id }}">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ eval.id }}" aria-expanded="false" aria-controls="collapse-{{ eval.id }}">
            <strong>{{ eval.agent_name }}</strong> ({{ eval.evaluator_name }}, {{ eval.model_name }})
            <span class="ms-3 text-muted small">{{ eval.created_at.strftime("%Y-%m-%d %H:%M") if eval.created_at else "-" }}</span>
          </button>
        </h2>
        <div id="collapse-{{ eval.id }}" class="accordion-collapse collapse" aria-labelledby="heading-{{ eval.id }}" data-bs-parent="#evaluationAccordion">
          <div class="accordion-body">
            <p><strong>Strategy:</strong> {{ eval.strategy or "-" }}</p>
            <p><strong>Model Name:</strong> {{ eval.model_name or "-" }}</p>
            <p><strong>Target:</strong> {{ eval.target_type }} → {{ eval.target_id }}</p>
            
            <h5>Scores</h5>
            {% if eval.dimension_scores %}
              <table class="table table-sm table-bordered">
                <thead>
                  <tr>
                    <th>Dimension</th>
                    <th>Score</th>
                    <th>Source</th>
                  </tr>
                </thead>
                <tbody>
                  {% for score in eval.dimension_scores %}
                  <tr>
                    <td>{{ score.dimension }}</td>
                    <td>{{ "%.3f"|format(score.score) }}</td>
                    <td>{{ score.source or "-" }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            {% elif eval.scores %}
              <pre class="bg-light p-2 rounded">{{ eval.scores | tojson(indent=2) }}</pre>
            {% else %}
              <p class="text-muted">No scores recorded.</p>
            {% endif %}

            {% if eval.attributes %}
              <h6 class="mt-3">Attributes</h6>
              <ul>
                {% for attr in eval.attributes %}
                  <li><strong>{{ attr.key }}</strong>: {{ attr.value }}</li>
                {% endfor %}
              </ul>
            {% endif %}
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="alert alert-warning">⚠️ No evaluations found for this pipeline run.</div>
  {% endif %}
</div>
{% endblock %}
