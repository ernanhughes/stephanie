{% extends "base.html" %}
{% block content %}
<div class="container my-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">SSP — Search Self-Play</h2>
    <div class="d-flex gap-2">
      <button id="btnStart" class="btn btn-sm btn-success">Start</button>
      <button id="btnStop" class="btn btn-sm btn-outline-danger">Stop</button>
      <button id="btnTick" class="btn btn-sm btn-primary">Tick</button>
    </div>
  </div>

  <div class="row g-3">
    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5>Status</h5>
          <table class="table table-sm">
            <tbody id="statusTable">
              <tr><th>State</th>       <td id="st-status">—</td></tr>
              <tr><th>Episodes</th>    <td id="st-episodes">—</td></tr>
              <tr><th>Difficulty</th>  <td id="st-difficulty">—</td></tr>
              <tr><th>Tick Interval</th><td id="st-tick">—</td></tr>
            </tbody>
          </table>
          <small class="text-muted">Auto-refresh every 2s while running.</small>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5>Last Metrics</h5>
          <pre id="lastMetrics" class="small bg-light p-2 rounded" style="white-space: pre-wrap;">—</pre>
        </div>
      </div>
    </div>

    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5>Last Jitter Tick</h5>
          <pre id="lastTick" class="small bg-light p-2 rounded" style="white-space: pre-wrap;">—</pre>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  async function getStatus() {
    const r = await fetch('/ssp/status');
    return await r.json();
  }
  function renderStatus(s) {
    document.getElementById('st-status').innerText = s.status ?? '—';
    document.getElementById('st-episodes').innerText = s.episode_count ?? 0;
    const diff = s.difficulty;
    document.getElementById('st-difficulty').innerText = (typeof diff === 'number') ? diff.toFixed(2) : (diff ?? '—');
    document.getElementById('st-tick').innerText = s.tick_interval ?? '—';
    document.getElementById('lastMetrics').innerText = JSON.stringify(s.last_metrics ?? {}, null, 2);
    document.getElementById('lastTick').innerText = JSON.stringify(s.last_tick ?? {}, null, 2);
  }
  async function start(max_steps=null) {
    const qs = max_steps ? ('?max_steps=' + encodeURIComponent(max_steps)) : '';
    const r = await fetch('/ssp/start' + qs, {method:'POST'});
    await r.json(); // ignore body; we’ll re-pull status
    renderStatus(await getStatus());
  }
  async function stop() {
    const r = await fetch('/ssp/stop', {method:'POST'});
    await r.json();
    renderStatus(await getStatus());
  }
  async function tick() {
    const r = await fetch('/ssp/tick', {method:'POST'});
    const out = await r.json();
    document.getElementById('lastTick').innerText = JSON.stringify(out, null, 2);
  }

  document.getElementById('btnStart').addEventListener('click', ()=> start());
  document.getElementById('btnStop').addEventListener('click', ()=> stop());
  document.getElementById('btnTick').addEventListener('click', ()=> tick());

  async function loop() {
    try { renderStatus(await getStatus()); } catch (e) {}
    setTimeout(loop, 2000);
  }
  loop();
</script>
{% endblock %}
