{% extends "base.html" %}
{% block content %}
<div class="container-fluid py-3">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h3 class="mb-0">Nexus Run: <code id="runId">{{ run_id }}</code></h3>
    <div class="d-flex gap-2">
      <a class="btn btn-sm btn-outline-secondary" href="/nexus">← All runs</a>
      <a class="btn btn-sm btn-outline-primary" id="btnReload">Reload</a>
    </div>
  </div>

  <div class="row g-3">
    <div class="col-lg-8">
      <div class="card shadow-sm">
        <div class="card-body" style="height: 70vh;">
          <div id="cy" style="width:100%; height:100%; border:1px solid #e5e7eb; border-radius:8px;"></div>
        </div>
      </div>
      <div class="mt-2 small text-muted">
        Tip: click a node to see details; use the filter to toggle edge types.
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card shadow-sm mb-3">
        <div class="card-body">
          <h5 class="card-title">Manifest</h5>
          <pre id="manifestPre" class="small" style="white-space:pre-wrap; max-height:30vh; overflow:auto;">Loading…</pre>
          <div class="mt-2 d-flex gap-2">
            <label class="form-label me-2 mb-0">Show edges:</label>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="checkbox" id="chkKnn" checked>
              <label class="form-check-label" for="chkKnn">knn_global</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="checkbox" id="chkTemporal" checked>
              <label class="form-check-label" for="chkTemporal">temporal_next</label>
            </div>
          </div>
        </div>
      </div>

      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title">Selected</h5>
          <pre id="selectedPre" class="small" style="white-space:pre-wrap; max-height:30vh; overflow:auto;">—</pre>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Cytoscape.js (CDN). If you prefer local, drop a copy into /static and change the src -->
<script src="https://unpkg.com/cytoscape@3.27.0/dist/cytoscape.min.js"></script>
<script>
const RUN_ID = {{ run_id | tojson }};
const cyContainer = document.getElementById('cy');
const $manifest   = document.getElementById('manifestPre');
const $selected   = document.getElementById('selectedPre');
const $btnReload  = document.getElementById('btnReload');
const $chkKnn     = document.getElementById('chkKnn');
const $chkTmp     = document.getElementById('chkTemporal');

let cy;
let rawGraph = {nodes:[], edges:[]};
let manifest = {};

async function fetchJSON(url) {
  const r = await fetch(url);
  if (!r.ok) throw new Error(`GET ${url} -> ${r.status}`);
  return await r.json();
}

function toCyElements(graph) {
  return [
    ...graph.nodes,
    ...graph.edges.filter(e => {
      const t = e?.data?.type;
      if (t === 'knn_global' && !$chkKnn.checked) return false;
      if (t === 'temporal_next' && !$chkTmp.checked) return false;
      return true;
    })
  ];
}

function initCy() {
  if (cy) { cy.destroy(); cy = null; }
  cy = cytoscape({
    container: cyContainer,
    elements: toCyElements(rawGraph),
    layout: { name: 'cose', animate: false },
    style: [
      { selector: 'node',
        style: {
          'background-color': '#5b8def',
          'label': 'data(label)',
          'font-size': 9,
          'text-wrap': 'wrap',
          'text-max-width': 140,
          'width': 'mapData(deg, 0, 12, 10, 32)',
          'height': 'mapData(deg, 0, 12, 10, 32)',
          'color': '#111'
        }
      },
      { selector: 'edge[type = "knn_global"]',
        style: {'line-color': '#999', 'width': 1, 'opacity': 0.9}
      },
      { selector: 'edge[type = "temporal_next"]',
        style: {'line-color': '#e83e8c', 'width': 2, 'opacity': 0.9, 'target-arrow-shape': 'triangle', 'target-arrow-color':'#e83e8c', 'curve-style':'bezier'}
      },
      { selector: ':selected',
        style: {'border-color': '#f59e0b', 'border-width': 2}
      }
    ]
  });

  cy.on('tap', 'node', (evt) => {
    const n = evt.target.data();
    const id = n.id;
    // show best-effort details: node payload may only have label/deg/type
    const entry = {
      id,
      label: n.label,
      type: n.type,
      deg: n.deg
    };
    $selected.textContent = JSON.stringify(entry, null, 2);
  });

  cy.ready(() => {
    // try a second pass layout for clarity
    cy.layout({ name: 'cose', animate: false }).run();
    cy.fit(cy.elements(), 30);
  });
}

async function loadAll() {
  // 1) Manifest
  try {
    manifest = await fetchJSON(`/nexus/run/${encodeURIComponent(RUN_ID)}/manifest`);
    $manifest.textContent = JSON.stringify(manifest, null, 2);
  } catch (e) {
    $manifest.textContent = 'Manifest load error: ' + e.message;
  }
  // 2) Graph
  try {
    rawGraph = await fetchJSON(`/nexus/run/${encodeURIComponent(RUN_ID)}/graph.json`);
  } catch (e) {
    rawGraph = {nodes:[], edges:[]};
  }
  // Add degree metric for sizing (optional)
  const degCount = {};
  (rawGraph.edges || []).forEach(e => {
    const s = e?.data?.source; const t = e?.data?.target;
    if (s) degCount[s] = (degCount[s] || 0) + 1;
    if (t) degCount[t] = (degCount[t] || 0) + 1;
  });
  (rawGraph.nodes || []).forEach(n => {
    const id = n?.data?.id;
    n.data.deg = degCount[id] || 0;
  });

  initCy();
}

$btnReload.onclick = loadAll;
$chkKnn.onchange = () => initCy();
$chkTmp.onchange = () => initCy();

loadAll();
</script>
{% endblock %}
I