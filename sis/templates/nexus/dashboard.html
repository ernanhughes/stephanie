{% extends "base.html" %}
{% block content %}
<div class="container my-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">üï∏Ô∏è Nexus Graph</h2>
    <div class="d-flex gap-2">
      <button id="btnBuild" class="btn btn-sm btn-success">Build</button>
      <button id="btnFinalize" class="btn btn-sm btn-primary">Finalize</button>
      <button id="btnRefresh" class="btn btn-sm btn-outline-secondary">Refresh</button>
    </div>
  </div>

  <div class="row g-3">
    <div class="col-lg-4">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5>Status</h5>
          <pre id="status" class="small bg-light p-2 rounded" style="white-space:pre-wrap;">‚Äî</pre>
          <h6 class="mt-3">Manifest</h6>
          <pre id="manifest" class="small bg-light p-2 rounded" style="white-space:pre-wrap; max-height: 240px; overflow:auto;">‚Äî</pre>
          <div id="artifacts" class="mt-2 small"></div>
        </div>
      </div>
    </div>

    <div class="col-lg-8">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5>Graph</h5>
          <div id="cy" style="height:70vh; border: 1px solid #ddd; border-radius: 6px;"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Cytoscape -->
<script src="https://unpkg.com/cytoscape@3.28.1/dist/cytoscape.min.js"></script>
<script>
const $status   = document.getElementById('status');
const $manifest = document.getElementById('manifest');
const $art      = document.getElementById('artifacts');
const $btnBuild = document.getElementById('btnBuild');
const $btnFin   = document.getElementById('btnFinalize');
const $btnRef   = document.getElementById('btnRefresh');

let cy = null;

function renderArtifacts(m) {
  const p = (m?.paths) || {};
  const keys = Object.keys(p);
  if (!keys.length) { $art.innerHTML = ''; return; }
  $art.innerHTML = `
    <div class="card card-body p-2">
      <div><strong>Artifacts</strong></div>
      <ul class="mb-0">
        ${keys.map(k => `<li>${k}: <code>${p[k]}</code></li>`).join('')}
      </ul>
    </div>`;
}

async function getJSON(url) { const r = await fetch(url); return await r.json(); }

async function refreshStatus() {
  try { $status.textContent = JSON.stringify(await getJSON('/nexus/status'), null, 2); }
  catch (e) { $status.textContent = 'Error: '+(e?.message||e); }
}

async function refreshManifest() {
  try {
    const m = await getJSON('/nexus/manifest');
    $manifest.textContent = JSON.stringify(m, null, 2);
    renderArtifacts(m);
  } catch (e) {
    $manifest.textContent = 'Error: '+(e?.message||e);
    $art.innerHTML = '';
  }
}

function buildCy(elements) {
  if (cy) cy.destroy();
  cy = cytoscape({
    container: document.getElementById('cy'),
    elements,
    layout: { name: 'cose', animate: false },
    style: [
      { selector: 'node',
        style: {
          'background-color': '#666',
          'label': 'data(label)',
          'font-size': 10,
          'color': '#222',
          'text-outline-color': '#fff',
          'text-outline-width': 2,
          'width': 'mapData(deg, 0, 20, 12, 30)',
          'height': 'mapData(deg, 0, 20, 12, 30)',
        }
      },
      { selector: 'edge[type = "temporal_next"]',
        style: {
          'line-color': '#5ec269',
          'target-arrow-color': '#5ec269',
          'target-arrow-shape': 'triangle',
          'width': 2,
          'curve-style': 'bezier',
        }
      },
      { selector: 'edge[type = "knn_global"]',
        style: {
          'line-color': '#56b6c2',
          'target-arrow-color': '#56b6c2',
          'target-arrow-shape': 'vee',
          'width': 'mapData(weight, 0, 1, 1, 3)',
          'curve-style': 'bezier',
        }
      },
      { selector: 'edge',
        style: { 'opacity': 0.9 }
      }
    ]
  });

  // Small QoL: highlight neighbors on tap
  cy.on('tap', 'node', (ev) => {
    const n = ev.target;
    const nbrs = n.closedNeighborhood();
    cy.elements().addClass('faded');
    nbrs.removeClass('faded');
  });
  cy.on('tap', (ev) => { if (ev.target === cy) cy.elements().removeClass('faded'); });

  cy.style().selector('.faded').style({'opacity': 0.15}).update();
}

async function refreshGraph() {
  const data = await getJSON('/nexus/graph.json');
  const elements = [...(data.nodes||[]), ...(data.edges||[])];
  buildCy(elements);
}

async function doBuild() {
  const r = await fetch('/nexus/build', { method: 'POST' });
  await r.json();
  await refreshGraph();
  await refreshManifest();
  await refreshStatus();
}

async function doFinalize() {
  const r = await fetch('/nexus/finalize', { method: 'POST' });
  await r.json();
  await refreshManifest();
  await refreshStatus();
}

$btnBuild.onclick = doBuild;
$btnFin.onclick   = doFinalize;
$btnRef.onclick   = async () => { await refreshGraph(); await refreshManifest(); await refreshStatus(); };

(async function boot() {
  await refreshGraph();
  await refreshManifest();
  await refreshStatus();
})();
</script>
{% endblock %}
