{# sis/templates/arena/tap.html #}
<!doctype html>
<meta charset="utf-8" />
<title>Arena Event Tap</title>
<style>
  body { font: 13px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 16px; }
  .row { display: flex; gap: 8px; align-items: center; margin-bottom: 8px; }
  #out { white-space: pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
         background: #0b0b0b; color: #c9f; padding: 10px; border-radius: 6px; height: 70vh; overflow: auto; }
  .badge { padding: 2px 6px; border-radius: 4px; background: #888; color: #fff; }
  .ok { background:#28a745 } .err { background:#dc3545 } .idle { background:#6c757d }
  input { padding: 6px 8px; border: 1px solid #ccc; border-radius: 6px; min-width: 22rem; }
  button { padding: 6px 10px; border: 1px solid #999; border-radius: 6px; cursor: pointer; background:#f3f3f3; }
</style>

<div class="row">
  <span>Status: <span id="status" class="badge idle">idle</span></span>
</div>
<div class="row">
  <label>Stream URL:</label>
  <input id="url" value="/tap/stream" />
</div>
<div class="row">
  <label>run_id (optional):</label>
  <input id="run" placeholder="e.g. 6409" />
</div>
<div class="row">
  <button id="connect">Connect</button>
  <button id="disconnect">Disconnect</button>
  <button id="clear">Clear</button>
</div>

<div id="out"></div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);
  let es = null;

  function setStatus(txt, cls) {
    const el = $("status");
    el.textContent = txt;
    el.className = `badge ${cls}`;
  }

  function log(obj) {
    const out = $("out");
    const line = typeof obj === "string" ? obj : JSON.stringify(obj, null, 2);
    out.textContent += line + "\n\n";
    out.scrollTop = out.scrollHeight;
    try { console.log("EVENT:", obj); } catch {}
  }

  function connect() {
    if (es) es.close();
    let u = $("url").value.trim() || "/arena/stream";
    const run = $("run").value.trim();
    try {
      const url = new URL(u, window.location.origin);
      if (run) url.searchParams.set("run_id", run);
      u = url.toString();
    } catch { /* if user put absolute URL already, keep it */ }

    setStatus("connecting...", "idle");
    log(`--- CONNECTING: ${u} ---`);

    es = new EventSource(u);
    es.onopen = () => { setStatus("open", "ok"); log({event:"_open", url: u, t: Date.now()/1000}); };
    es.onerror = (e) => { setStatus("error", "err"); log({event:"_error", t: Date.now()/1000}); };
    es.onmessage = (e) => {
      try { log(JSON.parse(e.data)); }
      catch { log(e.data); }
    };
  }

  function disconnect() {
    if (es) {
      es.close();
      es = null;
      setStatus("idle", "idle");
      log("--- DISCONNECTED ---");
    }
  }

  $("connect").addEventListener("click", connect);
  $("disconnect").addEventListener("click", disconnect);
  $("clear").addEventListener("click", () => { $("out").textContent = ""; });

  // auto-connect if loaded with ?run_id=...
  const params = new URLSearchParams(location.search);
  const rid = params.get("run_id");
  if (rid) { $("run").value = rid; }
  const urlOverride = params.get("url");
  if (urlOverride) { $("url").value = urlOverride; }
  // optional: auto-connect on load
  // connect();
})();
</script>
