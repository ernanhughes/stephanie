{# sis/templates/arena/live.html #}
{% extends "base.html" %}
{% block content %}
<div class="container my-4" id="app">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div class="d-flex align-items-center gap-3">
      <h2 class="mb-0">Arena Live</h2>
      <span id="chip-run" class="badge bg-secondary d-none"></span>
      <span id="chip-section" class="badge bg-secondary d-none"></span>
    </div>
    <div class="d-flex align-items-center gap-2">
      <span id="status-dot" class="badge bg-secondary">idle</span>
      <select id="mode" class="form-select form-select-sm" style="width:auto">
        <option value="history" selected>History (DB)</option> 
        <option value="live">Live</option>
        <option value="replay">Replay JSON</option>
      </select>
      <input id="run-id" class="form-control form-control-sm" placeholder="run_id (optional)" style="width:16rem">
      <button id="btn-connect" class="btn btn-sm btn-primary">Connect</button>
      <button id="btn-clear" class="btn btn-sm btn-outline-secondary">Clear</button>
      <div class="vr mx-1"></div>
      <button id="btn-snapshot" class="btn btn-sm btn-outline-success" title="Download current state as JSON">Capture snapshot</button>
      <label class="btn btn-sm btn-outline-dark mb-0">
        Load JSON<input id="file-replay" type="file" accept="application/json" hidden>
      </label>
    </div>
  </div>

  <div id="errbar" class="alert alert-danger py-2 px-3 d-none" role="alert">
    <strong>Error:</strong> <span id="errmsg"></span>
  </div>

  <div class="row g-3">
    <div class="col-lg-8">
      <div class="card shadow-sm mb-3">
        <div class="card-header">Progress</div>
        <div class="card-body">
          <ul class="nav nav-tabs" id="chartTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-best" type="button">Best overall</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-marg" type="button">Marginal / kTok</button>
            </li>
          </ul>
          <div class="tab-content pt-3">
            <div class="tab-pane fade show active" id="tab-best">
              <canvas id="chart-best" height="140"></canvas>
            </div>
            <div class="tab-pane fade" id="tab-marg">
              <canvas id="chart-marg" height="140"></canvas>
            </div>
          </div>
        </div>
      </div>

      <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>Timeline</span>
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="autoscroll" checked>
            <label class="form-check-label small" for="autoscroll">Auto-scroll</label>
          </div>
        </div>
        <div class="card-body" style="max-height:320px; overflow:auto" id="timeline"></div>
      </div>
    </div><!-- /col -->

    <div class="col-lg-4">
      <div class="card shadow-sm mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>Summary / Winner</span>
          <button id="btn-toggle-winner" class="btn btn-sm btn-outline-secondary">Collapse</button>
        </div>
        <div class="card-body" id="winner-card">
          <dl class="row mb-0">
            <dt class="col-6">Winner overall</dt><dd class="col-6 text-end" id="sum-winner">—</dd>
            <dt class="col-6">Rounds run</dt><dd class="col-6 text-end" id="sum-rounds">—</dd>
            <dt class="col-6">Reason</dt><dd class="col-6 text-end" id="sum-reason">—</dd>
          </dl>
          <hr class="my-2">
          <div class="small text-muted" id="winner-note">
            Winner excerpt not included in events. If you emit it server-side (e.g. on <code>arena_done</code>), it will appear here.
          </div>
          <pre id="winner-excerpt" class="small d-none" style="white-space:pre-wrap"></pre>
        </div>
      </div>

      <div class="card shadow-sm">
        <div class="card-header">Top-K Preview</div>
        <div class="card-body">
          <div class="table-responsive" style="max-height:220px;overflow:auto">
            <table class="table table-sm">
              <thead><tr><th>Origin</th><th>Variant</th><th class="text-end">Overall</th><th class="text-end">k</th><th>Verified</th></tr></thead>
              <tbody id="topk-body"><tr><td colspan="5" class="text-muted">Waiting…</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>
    </div><!-- /col -->
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.5.0/dist/chart.umd.min.js"></script>
<script>
(() => {
  const $ = (id) => document.getElementById(id);

  // -------- state ----------
  const state = {
    run_id: null,
    section_name: null,
    events: [],
    best_history: [],
    marg_history: [],
    labels: [],
    topk: [],
    summary: null,
    winner_excerpt: null,
  };

  let es = null;
  let roundIdx = 0;

  // -------- charts ----------
  const bestChart = new Chart($("chart-best").getContext("2d"), {
    type: "line",
    data: { labels: [], datasets: [{ label: "best overall", data: [], borderWidth: 2 }]},
    options: { responsive: true, scales: { y: { beginAtZero: false }}, plugins: { legend: { display: false } } }
  });
  const margChart = new Chart($("chart-marg").getContext("2d"), {
    type: "line",
    data: { labels: [], datasets: [{ label: "marginal/kTok", data: [], borderWidth: 2 }]},
    options: { responsive: true, scales: { y: { beginAtZero: false }}, plugins: { legend: { display: false } } }
  });

  // -------- ui helpers ----------
  function setStatus(s) {
    $("status-dot").textContent = s;
    $("status-dot").className = "badge " + (s === "open" ? "bg-success" : s === "connecting" ? "bg-warning" : s === "error" ? "bg-danger" : "bg-secondary");
  }
  function showError(msg) {
    $("errmsg").textContent = msg || "Unknown error";
    $("errbar").classList.remove("d-none");
  }
  function hideError() {
    $("errbar").classList.add("d-none");
  }
  function setChip(id, text) {
    const el = $(id);
    if (!text) { el.classList.add("d-none"); return; }
    el.textContent = text;
    el.classList.remove("d-none");
  }

  function tryParseJSON(x) {
    if (typeof x !== "string") return x;
    const t = x.trim();
    if (!t) return x;
    try { return JSON.parse(t); } catch { return x; }
  }

  function addTimeline(ev) {
    const d = document.createElement("div");
    d.className = "small";
    const extra = [];
    if (ev.round != null) extra.push("r" + ev.round);
    if (ev.best_overall != null) extra.push("best "+ Number(ev.best_overall).toFixed(3));
    if (ev.marginal_per_ktok != null) extra.push("marg/kTok "+ Number(ev.marginal_per_ktok).toFixed(3));
    if (ev.reason) extra.push("reason " + ev.reason);
    const sum = ev.summary || ev.arena_summary;
    if (sum?.winner_overall != null) extra.push("winner " + Number(sum.winner_overall).toFixed(3));
    const ts = new Date().toLocaleTimeString();
    d.textContent = `[${ts}] ${ev.event}` + (extra.length ? " · " + extra.join(" · ") : "");
    $("timeline").appendChild(d);
    if ($("autoscroll").checked) $("timeline").scrollTop = $("timeline").scrollHeight;
  }

  function setTopK(topk) {
    state.topk = topk || [];
    const tbody = $("topk-body");
    tbody.innerHTML = "";
    if (!state.topk.length) {
      tbody.innerHTML = '<tr><td colspan="5" class="text-muted">No data</td></tr>';
      return;
    }
    for (const t of state.topk) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${t.origin ?? "—"}</td>
                      <td>${t.variant ?? "—"}</td>
                      <td class="text-end">${Number(t.overall ?? 0).toFixed(3)}</td>
                      <td class="text-end">${Number(t.k ?? 0).toFixed(3)}</td>
                      <td>${t.verified ? "yes" : "no"}</td>`;
      tbody.appendChild(tr);
    }
  }

  function updateSummary(sum) {
    state.summary = sum || null;
    $("sum-winner").textContent = sum?.winner_overall != null ? Number(sum.winner_overall).toFixed(3) : "—";
    $("sum-rounds").textContent = sum?.rounds_run ?? "—";
    $("sum-reason").textContent = sum?.reason ?? "—";
  }

  // -------- tap → arena normalize ----------
  function normalizeFromTap(msg) {
    // tap emits: { subject, data: <envelope or raw> } — may be stringified
    let x = tryParseJSON(msg?.data ?? msg);

    // Event-service envelope → payload (also may be stringified)
    if (x && typeof x === "object" && x.payload != null) {
      x = tryParseJSON(x.payload);
    }

    // Some producers nest payload again
    if (x && typeof x === "object" && x.payload != null && x.payload.event) {
      x = tryParseJSON(x.payload);
    }

    // If we STILL got a string, try once more
    x = tryParseJSON(x);

    return x || {};
  }

  // -------- event handler ----------
  function handleTapMessage(msg, runFilter) {
    const body = normalizeFromTap(msg);
    if (!body || typeof body !== "object" || !body.event) return;

    // Client-side run_id filter (tap doesn't filter)
    if (runFilter && String(body.run_id || "") !== String(runFilter)) return;

    // chips
    if (body.run_id && !state.run_id) state.run_id = String(body.run_id);
    if (body.section_name && !state.section_name) state.section_name = String(body.section_name);
    setChip("chip-run", state.run_id ? `run_id: ${state.run_id}` : null);
    setChip("chip-section", state.section_name ? `section: ${state.section_name}` : null);

    // raw buffer + timeline
    state.events.push(body);
    addTimeline(body);

    // widgets
    if (body.event === "initial_scored" && body.topk) {
      setTopK(body.topk);
    }
    if (body.event === "round_end") {
      roundIdx += 1;
      state.labels.push(String(roundIdx));
      state.best_history.push(body.best_overall ?? null);
      state.marg_history.push(body.marginal_per_ktok ?? null);

      bestChart.data.labels = state.labels.slice();
      bestChart.data.datasets[0].data = state.best_history.slice();
      margChart.data.labels = state.labels.slice();
      margChart.data.datasets[0].data = state.marg_history.slice();
      bestChart.update(); margChart.update();
    }
    if (body.event === "arena_stop" && body.winner_overall != null) {
      updateSummary({ winner_overall: body.winner_overall, rounds_run: body.rounds_run, reason: body.reason });
    }
    const sum = body.summary || body.arena_summary;
    if (body.event === "arena_done" && sum) {
      updateSummary(sum);
    }
    if (body.event === "arena_done" && body.winner_excerpt) {
      state.winner_excerpt = body.winner_excerpt;
      $("winner-note").classList.add("d-none");
      $("winner-excerpt").classList.remove("d-none");
      $("winner-excerpt").textContent = String(body.winner_excerpt).slice(0, 1200);
    }
  }

  // -------- live connect (tap) ----------
  function connectLive() {
    const runFilter = $("run-id").value.trim();
    if (es) { es.close(); es = null; }
    setStatus("connecting"); hideError();

    // Subscribe to arena subjects on the bus via tap
    const url = new URL("/tap/stream", window.location.origin);
    url.searchParams.set("subject", "stephanie.events.arena.run.>"); // adjust prefix if needed
    url.searchParams.set("debug", "1");

    const src = new EventSource(url);
    es = src;

    src.onopen = () => setStatus("open");
    src.onerror = () => { setStatus("error"); showError("SSE connection error"); };
    src.onmessage = (e) => {
      try {
        const obj = JSON.parse(e.data);
        // obj is {subject, data: envelope|json}
        handleTapMessage(obj, runFilter);
      } catch {
        // ignore non-JSON
      }
    };
  }

  async function connectHistory() {
    const runId = document.getElementById("run-id").value.trim();
    if (!runId) { alert("Enter a run_id first"); return; }

    // ... (clear UI as you already do)

    try {
      const res = await fetch(`/tap/api/events?run_id=${encodeURIComponent(runId)}`);
      if (!res.ok) throw new Error("HTTP " + res.status);
      const raw = await res.json();                // array of strings or objects
      const events = raw.map(tryParseJSON);        // <- normalize to objects

      setChip("chip-run", `run_id: ${runId}`);

      let i = 0;
      const tick = () => {
        if (i >= events.length) { setStatus("open"); return; }
        const body = events[i++];
        handleTapMessage({ data: { payload: body } }, /*runFilter*/ null);
        setTimeout(tick, 20);
      };
      tick();
    } catch (err) {
      setStatus("error");
      showError("Failed to load history: " + (err?.message || String(err)));
    }
  }

  function connectReplayFromEvents(events) {
    if (!Array.isArray(events)) return;
    clearAll();
    const parsed = events.map(tryParseJSON);       // <- normalize to objects
    let i = 0;
    const tick = () => {
      if (i >= parsed.length) return;
      const body = parsed[i++];
      handleTapMessage({ data: { payload: body } }, /*runFilter*/ null);
      setTimeout(tick, 80);
    };
    tick();
  }

  function downloadSnapshot() {
    const snapshot = {
      saved_at: new Date().toISOString(),
      run_id: state.run_id,
      section_name: state.section_name,
      events: state.events,
      derived: {
        labels: state.labels,
        best_history: state.best_history,
        marg_history: state.marg_history,
        topk: state.topk,
        summary: state.summary,
        winner_excerpt: state.winner_excerpt,
      }
    };
    const blob = new Blob([JSON.stringify(snapshot, null, 2)], {type: "application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `arena-snapshot-${state.run_id || "run"}.json`;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  function clearAll() {
    if (es) { es.close(); es = null; }
    setStatus("idle"); hideError();
    state.labels = []; state.best_history = []; state.marg_history = [];
    bestChart.data.labels = []; bestChart.data.datasets[0].data = [];
    margChart.data.labels = []; margChart.data.datasets[0].data = [];
    bestChart.update(); margChart.update();
    $("timeline").innerHTML = "";
    setTopK([]); updateSummary(null);
    $("winner-note").classList.remove("d-none");
    $("winner-excerpt").classList.add("d-none");
    $("winner-excerpt").textContent = "";
    state.run_id = null; state.section_name = null;
    setChip("chip-run", null); setChip("chip-section", null);
    state.events = []; roundIdx = 0;
  }

  // -------- UI wiring ----------
  document.getElementById("btn-connect").addEventListener("click", () => {
    const mode = document.getElementById("mode").value;
    if (mode === "live") return connectLive();
    if (mode === "history") return connectHistory();
    if (mode === "replay") {
      showError("Replay mode: choose a JSON file with the ‘Load JSON’ button.");
    }
  });

  $("btn-clear").addEventListener("click", clearAll);
  $("btn-snapshot").addEventListener("click", downloadSnapshot);

  $("btn-toggle-winner").addEventListener("click", () => {
    const body = $("winner-card");
    if (body.classList.contains("d-none")) {
      body.classList.remove("d-none");
      $("btn-toggle-winner").textContent = "Collapse";
    } else {
      body.classList.add("d-none");
      $("btn-toggle-winner").textContent = "Expand";
    }
  });

  document.getElementById("mode").addEventListener("change", () => {
    const mode = document.getElementById("mode").value;
    const live = mode === "live";
    const needsRun = mode !== "replay";
    document.getElementById("run-id").disabled = !needsRun;
    document.getElementById("btn-connect").disabled = false;
  });

 $("file-replay").addEventListener("change", async (e) => {
    const f = e.target.files?.[0];
    if (!f) return;
    try {
      const txt = await f.text();
      const obj = JSON.parse(txt);
      const events = Array.isArray(obj) ? obj : (obj.events || []);
      connectReplayFromEvents(events);
      setStatus("open"); hideError();
    } catch (err) {
      showError("Failed to load JSON: " + (err?.message || String(err)));
    } finally {
      e.target.value = "";
    }
  });

  // deep-link support and auto-connect
  const urlParams = new URLSearchParams(window.location.search);
  const rid = urlParams.get("run_id");
  if (rid) {
    document.getElementById("run-id").value = rid;
    document.getElementById("mode").value = "history";
    connectHistory();
  } else {
    // Fallback: live (as before)
    connectLive();
  }
})();

</script>
{% endblock %}
