{# sis/templates/arena/live.html #}
{% extends "base.html" %}
{% block content %}
<div class="container my-4" id="app">
  <!-- Header Controls -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div class="d-flex align-items-center gap-3">
      <h2 class="mb-0">Arena Live</h2>
      <span id="chip-run" class="badge bg-secondary d-none"></span>
      <span id="chip-section" class="badge bg-secondary d-none"></span>
    </div>
    <div class="d-flex align-items-center gap-2">
      <span id="status-dot" class="badge bg-secondary">idle</span>
      <select id="mode" class="form-select form-select-sm" style="width:auto">
        <option value="history" selected>History (DB)</option> 
        <option value="live">Live</option>
        <option value="replay">Replay JSON</option>
      </select>
      <input id="run-id" class="form-control form-control-sm" placeholder="run_id (optional)" style="width:16rem">
      <button id="btn-connect" class="btn btn-sm btn-primary">Connect</button>
      <button id="btn-clear" class="btn btn-sm btn-outline-secondary">Clear</button>
      <div class="vr mx-1"></div>
      <button id="btn-snapshot" class="btn btn-sm btn-outline-success" title="Download current state as JSON">Capture snapshot</button>
      <label class="btn btn-sm btn-outline-dark mb-0">
        Load JSON<input id="file-replay" type="file" accept="application/json" hidden>
      </label>
    </div>
  </div>

  <!-- Error Bar -->
  <div id="errbar" class="alert alert-danger py-2 px-3 d-none" role="alert">
    <strong>Error:</strong> <span id="errmsg"></span>
  </div>

  <!-- Main Content Grid -->
  <div class="row g-3">
    <div class="col-lg-8">
      <!-- Charts Section -->
      {% include "arena/components/charts.html" %}
      
      <!-- Timeline Section -->
      <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>Timeline</span>
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="autoscroll" checked>
            <label class="form-check-label small" for="autoscroll">Auto-scroll</label>
          </div>
        </div>
        <div class="card-body" style="max-height:320px; overflow:auto" id="timeline"></div>
      </div>
    </div><!-- /col -->

    <div class="col-lg-4">
      <!-- Summary/Winner Card -->
      <div class="card shadow-sm mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>Summary / Winner</span>
          <button id="btn-toggle-winner" class="btn btn-sm btn-outline-secondary">Collapse</button>
        </div>
        <div class="card-body" id="winner-card">
          <dl class="row mb-0">
            <dt class="col-6">Winner overall</dt><dd class="col-6 text-end" id="sum-winner">—</dd>
            <dt class="col-6">Rounds run</dt><dd class="col-6 text-end" id="sum-rounds">—</dd>
            <dt class="col-6">Reason</dt><dd class="col-6 text-end" id="sum-reason">—</dd>
          </dl>
          <hr class="my-2">
          <div class="small text-muted" id="winner-note">
            Winner excerpt not included in events. If you emit it server-side (e.g. on <code>arena_done</code>), it will appear here.
          </div>
          <pre id="winner-excerpt" class="small d-none" style="white-space:pre-wrap"></pre>
        </div>
      </div>

      <!-- Top-K Grid -->
      <div class="card shadow-sm">
        <div class="card-header">Top-K Preview</div>
        <div class="card-body">
          <div class="table-responsive" style="max-height:220px; overflow:auto">
            <table class="table table-sm">
              <thead><tr><th>Origin</th><th>Variant</th><th class="text-end">Overall</th><th class="text-end">k</th><th>Verified</th></tr></thead>
              <tbody id="topk-body"><tr><td colspan="5" class="text-muted">Waiting…</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>
    </div><!-- /col -->
  </div>
</div>

<!-- Provenance Card Offcanvas -->
{% include "arena/components/provenance_card.html" %}


<!-- Add to base.html or live.html head -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.5.0/dist/chart.umd.min.js"></script>
<!-- External Resources -->
<link rel="stylesheet" href="{{ url_for('static', path='/css/arena_live.css') }}">
<script src="{{ url_for('static', path='/js/arena_live.js') }}" type="module" defer></script>

<!-- Add to <head> of live.html -->
{% endblock %}