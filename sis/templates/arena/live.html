{% extends "base.html" %}
{% block content %}
<div class="container my-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">Arena Live</h2>
    <div class="d-flex align-items-center gap-2">
      <span id="status-dot" class="badge bg-secondary">idle</span>
      <input id="run-id" class="form-control form-control-sm" placeholder="run_id (optional)" style="width:16rem">
      <button id="btn-connect" class="btn btn-sm btn-primary">Connect</button>
      <button id="btn-clear" class="btn btn-sm btn-outline-secondary">Clear</button>
    </div>
  </div>

  <div class="row g-3">
    <div class="col-lg-8">
      <div class="card shadow-sm">
        <div class="card-header">Progress</div>
        <div class="card-body">
          <ul class="nav nav-tabs" id="chartTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-best" type="button">Best overall</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-marg" type="button">Marginal / kTok</button>
            </li>
          </ul>
          <div class="tab-content pt-3">
            <div class="tab-pane fade show active" id="tab-best">
              <canvas id="chart-best" height="140"></canvas>
            </div>
            <div class="tab-pane fade" id="tab-marg">
              <canvas id="chart-marg" height="140"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div><!-- /col -->

    <div class="col-lg-4">
      <div class="card shadow-sm mb-3">
        <div class="card-header">Summary</div>
        <div class="card-body">
          <dl class="row mb-0">
            <dt class="col-6">Winner overall</dt><dd class="col-6 text-end" id="sum-winner">—</dd>
            <dt class="col-6">Rounds run</dt><dd class="col-6 text-end" id="sum-rounds">—</dd>
            <dt class="col-6">Reason</dt><dd class="col-6 text-end" id="sum-reason">—</dd>
          </dl>
        </div>
      </div>

      <div class="card shadow-sm">
        <div class="card-header">Top-K Preview</div>
        <div class="card-body">
          <div class="table-responsive" style="max-height:220px;overflow:auto">
            <table class="table table-sm">
              <thead><tr><th>Origin</th><th>Variant</th><th class="text-end">Overall</th><th class="text-end">k</th><th>Verified</th></tr></thead>
              <tbody id="topk-body"><tr><td colspan="5" class="text-muted">Waiting…</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>
    </div><!-- /col -->
  </div>

  <div class="card shadow-sm mt-3">
    <div class="card-header">Timeline</div>
    <div class="card-body" style="max-height:320px; overflow:auto" id="timeline"></div>
  </div>
</div>

<!-- Chart.js (you can vendor this locally if you prefer) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
(() => {
  const $ = (id) => document.getElementById(id);
  let es = null;
  let status = "idle";
  let bestData = [];
  let margData = [];
  let roundIdx = 0;

  const bestChart = new Chart($("chart-best").getContext("2d"), {
    type: "line",
    data: { labels: [], datasets: [{ label: "best overall", data: [], borderWidth: 2 }]},
    options: { responsive: true, scales: { y: { beginAtZero: false }}, plugins: { legend: { display: false } } }
  });
  const margChart = new Chart($("chart-marg").getContext("2d"), {
    type: "line",
    data: { labels: [], datasets: [{ label: "marginal/kTok", data: [], borderWidth: 2 }]},
    options: { responsive: true, scales: { y: { beginAtZero: false }}, plugins: { legend: { display: false } } }
  });

  function setStatus(s) {
    status = s;
    $("status-dot").textContent = s;
    $("status-dot").className = "badge " + (s === "open" ? "bg-success" : s === "connecting" ? "bg-warning" : s === "error" ? "bg-danger" : "bg-secondary");
  }

  function addTimeline(ev) {
    const d = document.createElement("div");
    d.className = "small";
    const extra = [];
    if (ev.round != null) extra.push("r" + ev.round);
    if (ev.best_overall != null) extra.push("best "+ Number(ev.best_overall).toFixed(3));
    if (ev.marginal_per_ktok != null) extra.push("marg/kTok "+ Number(ev.marginal_per_ktok).toFixed(3));
    if (ev.reason) extra.push("reason " + ev.reason);
    if (ev.summary?.winner_overall != null) extra.push("winner " + Number(ev.summary.winner_overall).toFixed(3));
    d.textContent = `[${new Date().toLocaleTimeString()}] ${ev.event}` + (extra.length ? " · " + extra.join(" · ") : "");
    $("timeline").appendChild(d);
    $("timeline").scrollTop = $("timeline").scrollHeight;
  }

  function setTopK(topk) {
    const tbody = $("topk-body");
    tbody.innerHTML = "";
    if (!topk || !topk.length) {
      tbody.innerHTML = '<tr><td colspan="5" class="text-muted">No data</td></tr>';
      return;
    }
    for (const t of topk) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${t.origin ?? "—"}</td>
                      <td>${t.variant ?? "—"}</td>
                      <td class="text-end">${(t.overall ?? 0).toFixed(3)}</td>
                      <td class="text-end">${(t.k ?? 0).toFixed(3)}</td>
                      <td>${t.verified ? "yes" : "no"}</td>`;
      tbody.appendChild(tr);
    }
  }

  function updateSummary(sum) {
    if (!sum) return;
    $("sum-winner").textContent = (sum.winner_overall ?? 0).toFixed(3);
    $("sum-rounds").textContent = sum.rounds_run ?? "—";
    $("sum-reason").textContent = sum.reason ?? "—";
  }

  function handle(ev) {
    addTimeline(ev);

    if (ev.event === "initial_scored" && ev.topk) {
      setTopK(ev.topk);
    }
    if (ev.event === "round_end") {
      roundIdx += 1;
      bestChart.data.labels.push(String(roundIdx));
      margChart.data.labels.push(String(roundIdx));
      bestChart.data.datasets[0].data.push(ev.best_overall ?? null);
      margChart.data.datasets[0].data.push(ev.marginal_per_ktok ?? null);
      bestChart.update();
      margChart.update();
    }
    if (ev.event === "arena_stop" && ev.winner_overall != null) {
      updateSummary({ winner_overall: ev.winner_overall, rounds_run: ev.rounds_run, reason: ev.reason });
    }
    if (ev.event === "arena_done" && ev.summary) {
      updateSummary(ev.summary);
    }
  }

  async function prefill(runId) {
    // optional: pull some history from DB if configured
    try {
      const url = new URL(window.location.origin + "/arena/api/recent");
      if (runId) url.searchParams.set("run_id", runId);
      const res = await fetch(url);
      if (!res.ok) return;
      const arr = await res.json();
      arr.forEach(handle);
    } catch {}
  }

  function connect() {
    const runId = $("run-id").value.trim();
    if (es) { es.close(); es = null; }
    setStatus("connecting");
    prefill(runId);
    const url = new URL(window.location.origin + "/arena/stream");
    if (runId) url.searchParams.set("run_id", runId);
    const src = new EventSource(url);
    es = src;
    src.onopen = () => setStatus("open");
    src.onerror = () => setStatus("error");
    src.onmessage = (e) => {
      try { handle(JSON.parse(e.data)); } catch {}
    };
  }

  $("btn-connect").addEventListener("click", connect);
  $("btn-clear").addEventListener("click", () => {
    $("timeline").innerHTML = "";
    bestChart.data.labels = [];
    bestChart.data.datasets[0].data = [];
    margChart.data.labels = [];
    margChart.data.datasets[0].data = [];
    bestChart.update(); margChart.update();
    setTopK([]);
    updateSummary(null);
    roundIdx = 0;
  });

  // auto-connect if ?run_id= is present
  const urlParams = new URLSearchParams(window.location.search);
  const rid = urlParams.get("run_id");
  if (rid) { $("run-id").value = rid; connect(); }
})();
</script>
{% endblock %}
