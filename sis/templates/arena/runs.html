{# sis/templates/arena/runs.html #}
{% extends "base.html" %}
{% block content %}
<div class="container my-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">Arena Runs</h2>
    <a class="btn btn-sm btn-outline-primary" href="/arena">Legacy detail</a>
  </div>

  <div class="card shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span>Latest runs</span>
      <div class="d-flex gap-2">
        <input id="search" class="form-control form-control-sm"
               placeholder="Search title, goal, run_id…" style="width:22rem">
      </div>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-sm mb-0 align-middle">
          <thead>
            <tr>
              <th style="width:2rem"></th>
              <th>Title / Goal</th>
              <th style="width:12rem">run_id</th>
              <th class="text-end" style="width:6rem">events</th>
              <th style="width:10rem">first</th>
              <th style="width:10rem">last</th>
              <th style="width:8rem">last event</th>
              <th style="width:12rem"></th>
            </tr>
          </thead>
          <tbody id="tbody"><tr><td colspan="8" class="text-muted p-3">Loading…</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);
  let rows = [];

  const fmtDate = (ts) => ts ? new Date(ts * 1000).toLocaleString() : "—";
  const esc = (s) => (s==null ? "" : String(s)
                    .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"));

  function render(list) {
    const tb = $("tbody");
    if (!list.length) {
      tb.innerHTML = '<tr><td colspan="8" class="text-muted p-3">No runs found</td></tr>';
      return;
    }
    tb.innerHTML = "";
    for (const r of list) {
      const title = r.title || r.paper_id || "—";
      const goal = r.goal ? ` — <span class="text-muted">${esc(r.goal)}</span>` : "";
      const metaLine = [
        r.section_name ? `section: ${esc(r.section_name)}` : null,
        r.agent ? `agent: ${esc(r.agent)}` : null
      ].filter(Boolean).join(" · ");

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${r.paper_id ? '<span class="badge bg-warning text-dark" title="paper_id">'+esc(r.paper_id)+'</span>' : ''}</td>
        <td style="max-width:20rem; white-space:normal; word-wrap:break-word;">
          <div class="fw-semibold text-truncate" title="${esc(title)}">${esc(title)}</div>
          <div class="small text-wrap">${r.goal_text || ""}</div>
          ${metaLine ? `<div class="small text-muted">${metaLine}</div>` : ""}
        </td>
        <td><code>${esc(r.run_id)}</code></td>
        <td class="text-end">${r.count}</td>
        <td>${fmtDate(r.first_ts)}</td>
        <td>${fmtDate(r.last_ts)}</td>
        <td class="text-nowrap">${esc(r.last_event ?? "—")}</td>
        <td class="text-end">
          <a class="btn btn-sm btn-primary"
             href="/arena/live?run_id=${encodeURIComponent(r.run_id)}">Live</a>
          <a class="btn btn-sm btn-outline-secondary ms-1"
             href="/arena?run_id=${encodeURIComponent(r.run_id)}">Details</a>
        </td>`;
      tb.appendChild(tr);
    }
  }

  function filter() {
    const q = $("search").value.trim().toLowerCase();
    if (!q) return render(rows);
    render(rows.filter(r =>
      String(r.run_id ?? "").toLowerCase().includes(q) ||
      String(r.title ?? "").toLowerCase().includes(q) ||
      String(r.goal ?? "").toLowerCase().includes(q) ||
      String(r.paper_id ?? "").toLowerCase().includes(q)
    ));
  }

  $("search").addEventListener("input", filter);

  fetch("/arena/api/runs?limit=50")
    .then(r => r.json())
    .then(data => { rows = data || []; render(rows); })
    .catch(() => {
      $("tbody").innerHTML = '<tr><td colspan="8" class="text-danger p-3">Failed to load.</td></tr>';
    });
})();
</script>
{% endblock %}
